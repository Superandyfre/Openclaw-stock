# 💰 现金管理功能修复说明

## 🐛 问题描述

**修复前的Bug：**
用户发送"总资金添加70000"、"可用资金添加70000"、"现金余额添加到10000000"等命令时：
- ❌ 系统错误理解为"设置总资产为70000"
- ❌ 由于持仓价值₩70,175，计算出可用现金 = 70000 - 70175 = 0
- ❌ 导致无法增加现金余额

**根本原因：**
系统没有区分"添加现金"和"调整总资产"两个不同的操作。

## ✅ 修复内容

### 1. 新增"添加现金"短路逻辑

在 [conversation_handler.py](openclaw/skills/analysis/conversation_handler.py#L576-L612) 添加了专门处理"添加现金"的代码：

```python
# 支持的命令格式：
- "现金添加10000"
- "可用资金添加70000"
- "总资金添加1000000"
- "现金余额添加到10000"
- "充值100000"
- "增加资金50000"
```

**执行逻辑：**
```python
self.tracker.cash += 添加金额
self.tracker.initial_capital += 添加金额
```

### 2. 更新LLM提示词

明确区分两种操作：
- 🟢 **添加现金**：系统自动处理，LLM无需输出任何标签
- 🔵 **调整总资产**：用于设置总资产为指定值（保留功能）

## 📖 使用指南

### ✅ 正确用法

#### 1. 资金倍数操作（新功能！）

**翻倍（×2）**
```
用户: 资金翻倍
Bot: ✅ 资金已翻倍
     原总资产：₩8,800,000
     添加金额：₩8,800,000
     新总资产：₩17,600,000
     可用现金：₩8,800,000 → ₩17,600,000
     持仓价值：₩0
```

**扩大N倍**
```
用户: 资金扩大3倍
Bot: ✅ 资金已扩大3.0倍
     原总资产：₩10,000,000
     添加金额：₩20,000,000
     新总资产：₩30,000,000
```

**增加N倍**（注意：增加2倍 = 原×3）
```
用户: 资金增加2倍
Bot: ✅ 资金已扩大3.0倍
     原总资产：₩10,000,000
     添加金额：₩20,000,000
     新总资产：₩30,000,000
```

#### 2. 增加固定金额

```
用户: 现金添加70000
Bot: ✅ 现金已添加
     添加金额：₩70,000
     可用现金：₩825 → ₩70,825
     总资产：₩71,000 → ₩141,000
     持仓价值：₩70,175
```

```
用户: 可用资金添加1000000
Bot: ✅ 现金已添加
     添加金额：₩1,000,000
     可用现金：₩825 → ₩1,000,825
     总资产：₩71,000 → ₩1,071,000
     持仓价值：₩70,175
```

#### 支持的所有命令格式

**倍数操作**
| 命令示例 | 说明 | 倍数 |
|---------|------|------|
| `资金翻倍` | 总资产×2 | ×2 |
| `总资产double` | 总资产×2 | ×2 |
| `资金×2` | 总资产×2 | ×2 |
| `资金扩大3倍` | 总资产×3 | ×3 |
| `资金变为5倍` | 总资产×5 | ×5 |
| `资金增加1倍` | 总资产×2 | ×(1+1) |
| `资金增加2倍` | 总资产×3 | ×(1+2) |

**添加固定金额**
| 命令示例 | 说明 |
|---------|------|
| `现金添加100000` | 添加10万韩元 |
| `可用资金添加50万` | 添加50万韩元 |
| `总资金增加1000000` | 添加100万韩元 |
| `账户余额充值200000` | 充值20万韩元 |
| `现金余额添加到500000` | 添加50万韩元 |
| `余额加500000` | 添加50万韩元 |
| `充值1000000` | 充值100万韩元 |

**关键词识别：**
- **倍数操作**：
  - 翻倍格式：翻倍、double、×2、*2、x2
  - 扩大/变为N倍：扩大N倍、变为N倍
  - 增加N倍：增加N倍（注意：增加2倍 = 原×3）
- **添加固定金额**：
  - 资金类型：总资金、现金、可用现金、账户余额、现金余额、可用资金、余额
  - 操作动词：添加、增加、充值、加、加上

### 📝 调整总资产（原有功能）

如果你想**重置**总资产为某个固定值：

```
用户: 总资产调整为5000000
Bot: ✅ 账户资金已更新
     总资产：₩5,000,000
     可用现金：₩4,929,825
     持仓价值：₩70,175
```

**注意：** 这会重新计算现金 = 总资产 - 持仓价值

## 🧪 测试示例

### 场景1：初始状态

```
💵 账户总资产：₩71,000
   可用现金：₩825
   持仓市值：₩70,175
```

### 场景2：添加70000现金

```
命令: 现金添加70000

结果:
✅ 现金已添加
   添加金额：₩70,000
   可用现金：₩825 → ₩70,825
   总资产：₩71,000 → ₩141,000
   持仓价值：₩70,175
```

### 场景3：再次添加100万

```
命令: 可用资金添加1000000

结果:
✅ 现金已添加
   添加金额：₩1,000,000
   可用现金：₩70,825 → ₩1,070,825
   总资产：₩141,000 → ₩1,141,000
   持仓价值：₩70,175
```

### 场景4：验证可用现金

```
命令: 可用现金

结果:
💵 账户总资产：₩1,141,000
   可用现金：₩1,070,825
   持仓市值：₩70,175
   初始资金：₩1,141,000
   🟢 总盈亏：+0（+0.00%）
```

## 🔧 技术细节

### 代码位置

- **添加现金短路**: [conversation_handler.py L576-L612](openclaw/skills/analysis/conversation_handler.py#L576)
- **调整总资产短路**: [conversation_handler.py L614-L649](openclaw/skills/analysis/conversation_handler.py#L614)
- **LLM提示词**: [conversation_handler.py L3075-L3088](openclaw/skills/analysis/conversation_handler.py#L3075)

### 正则表达式

```python
# 匹配"添加"操作（万为单位）
r'(?:'
r'(?:总?资金|现金|可用现金|账户余额|现金余额|可用资金|余额).*?(?:添加|增加|充值|加|加上)'
r'|(?:添加|增加|充值).*?(?:总?资金|现金|可用现金|账户余额|现金余额)'
r')\s*(?:到)?\s*(\d+(?:\.\d+)?)\s*万'

# 匹配"添加"操作（直接数字）
r'(?:'
r'(?:总?资金|现金|可用现金|账户余额|现金余额|可用资金|余额).*?(?:添加|增加|充值|加|加上)'
r'|(?:添加|增加|充值).*?(?:总?资金|现金|可用现金|账户余额|现金余额)'
r')\s*(?:到)?\s*(\d{4,})'
```

### 自动保存

修改后会自动触发持仓数据保存：
```python
self._auto_save()  # 保存到 positions.json
```

## ⚠️ 注意事项

1. **金额单位**
   - 纯数字（如70000）→ 韩元KRW
   - 带"万"（如50万）→ 自动乘以10000

2. **持仓价值不变**
   - 添加现金不会影响已有持仓
   - 只增加可用现金和总资产

3. **盈亏计算**
   - 初始资金会同步增加
   - 盈亏 = (现金 + 持仓市值) - 初始资金

## 🎯 最佳实践

### ✅ 推荐用法
```
现金添加100000      # 简洁明了
可用资金增加50万     # 支持万为单位
充值1000000         # 口语化表达
```

### ❌ 避免混淆
```
总资产调整为100000   # 这是设置总资产，不是添加！
资金改为50万         # 这是设置，会重新计算现金
```

---

**修复完成时间：** 2026-02-22 10:39  
**当前Bot状态：** ✅ 运行中 (PID=1951)  
**立即测试：** 向Telegram Bot发送 `现金添加70000`
