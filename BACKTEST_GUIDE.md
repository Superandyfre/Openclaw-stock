# 回测系统使用指南

## 概述

OpenClaw 回测系统允许你测试交易策略的历史表现，集成了强制风控规则（-10%止损、+20%收益目标、10小时窗口）。

## 核心功能

### 1. 增强型回测引擎 (EnhancedBacktest)

**强制风控参数：**
- **止损红线**: -10% (触发立即平仓)
- **止损警告**: -8% (发送警告)
- **收益目标**: +20%
- **利好通知**: +15%
- **最大持仓时间**: 10小时（短线策略）

**特点：**
- 自动计算止损价和目标价
- 实时风险告警模拟
- 详细的交易记录
- 性能指标计算（胜率、夏普比率、最大回撤等）

### 2. 回测数据获取器 (BacktestDataFetcher)

**支持的数据源：**
- 韩股历史数据 (pykrx)
- 日线/小时线数据
- 多标的批量获取

**内置策略：**
- **动量策略** (momentum): 价格上涨3%买入，下跌2%卖出
- **均值回归策略** (mean_reversion): 偏离5日均线±5%交易
- **突破策略** (breakout): 突破20日高点买入

## 使用方法

### 方法1：通过Telegram对话

**基本回测指令：**
```
回测一下三星电子最近30天的表现
```

**指定策略：**
```
测试动量策略，最近一个月
```

**多标的回测：**
```
给我看看005930、000660的历史回测
```

**自定义参数：**
```
回测三星电子，从2024-01-01到2024-02-01，使用突破策略
```

### 方法2：Python脚本

```python
from openclaw.skills.backtesting.enhanced_backtest import EnhancedBacktest
from openclaw.skills.backtesting.backtest_data_fetcher import BacktestDataFetcher
from datetime import datetime, timedelta

# 1. 初始化
fetcher = BacktestDataFetcher()

# 2. 获取历史数据
symbols = ['005930', '000660']  # 三星、SK海力士
end_date = datetime.now().strftime('%Y-%m-%d')
start_date = (datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d')

historical_data = fetcher.get_multiple_symbols(
    symbols, start_date, end_date, interval='1d'
)

# 3. 生成交易信号
signals = fetcher.generate_sample_signals(
    symbols, historical_data, strategy='momentum'
)

# 4. 运行回测
engine = EnhancedBacktest(
    initial_capital=10000000,  # 1000万韩元
    slippage_pct=0.002,        # 0.2% 滑点
    commission_pct=0.0015      # 0.15% 手续费
)

metrics = engine.run_backtest(
    historical_data=historical_data,
    signals=signals,
    max_position_size=0.2  # 单笔最大20%仓位
)

# 5. 查看结果
print(f"总收益: {metrics['total_return']:+.2f}%")
print(f"胜率: {metrics['win_rate']:.2f}%")
print(f"夏普比率: {metrics['sharpe_ratio']:.2f}")
print(f"最大回撤: {metrics['max_drawdown']:.2f}%")
```

## 回测报告示例

```
=== 回测报告 ===

策略：动量策略
标的：005930, 000660, 035420
周期：2026-01-20 ~ 2026-02-19

【资金情况】
初始资金：₩10,000,000
最终资金：₩9,841,226
总收益：-1.59% (₩-158,774)

【交易统计】
总交易次数：12
盈利次数：4
亏损次数：8
胜率：33.33%

【盈亏分析】
平均盈利：₩91,305
平均亏损：₩-75,423
盈亏比：1.21
最大盈利：₩180,893
最大亏损：₩-122,216

【风险指标】
夏普比率：-0.45
最大回撤：8.23%
平均持仓时间：48.5小时

【风控执行】
止损触发：0次 （-10%强制平仓）
止盈触发：0次 （+20%收益目标）
超时平仓：9次 （10小时窗口）
告警触发：2次 （-8%警告, +15%利好）

【风控参数】
止损红线：-10.0%
收益目标：20.0%
最大持仓：10小时

【总手续费】₩45,238
```

## 关键指标说明

### 性能指标

- **总收益率**: (最终资金 - 初始资金) / 初始资金 × 100%
- **胜率**: 盈利交易次数 / 总交易次数 × 100%
- **盈亏比**: 平均盈利 / |平均亏损|
- **夏普比率**: 风险调整后收益（年化）
- **最大回撤**: 从峰值到谷底的最大跌幅

### 风控指标

- **止损触发次数**: 触发-10%强制止损的次数
- **止盈触发次数**: 达到+20%收益目标的次数
- **超时平仓次数**: 超过10小时最大持仓时间的平仓次数
- **告警触发次数**: 包括-8%警告和+15%利好通知

## 策略对比

运行多策略对比测试：

```bash
cd /home/andy/projects/Openclaw-stock
source venv/bin/activate
python test_backtest_system.py
```

输出示例：
```
【策略对比】
策略                 收益率        胜率      夏普比率      最大回撤
momentum             +2.02%      50.00%      0.85        -6.37%
mean_reversion       -0.85%      45.45%     -0.32        -8.12%
breakout             +3.47%      60.00%      1.23        -4.89%
```

## 注意事项

### 1. 回测限制

- **历史数据**: 仅限韩股（pykrx），最多可回溯数年
- **数据周期**: 主要为日线，小时线为模拟数据
- **滑点和手续费**: 使用固定比例，实际可能更高

### 2. 风控规则

回测引擎**强制执行**以下规则：
- ✅ 开仓时自动计算止损价（-10%）和目标价（+20%）
- ✅ 价格更新时主动检测风险状态
- ✅ 触发-10%立即强制平仓（不可配置）
- ✅ 超过10小时自动平仓（不可配置）
- ✅ 告警记录所有风险事件

### 3. 回测 vs 实盘

回测结果**不代表**实际交易表现：
- 回测使用历史数据，无法预测未来
- 实盘交易受市场情绪、流动性等影响
- 滑点和手续费可能比回测中更高
- 回测不考虑资金管理和心理因素

### 4. 最佳实践

- 使用多种策略进行对比测试
- 测试不同时间周期（30天、60天、90天）
- 关注风险指标（最大回撤、夏普比率）
- 验证风控规则的有效性
- 结合市场环境分析结果

## 技术细节

### 文件结构

```
openclaw/skills/backtesting/
├── __init__.py
├── enhanced_backtest.py       # 增强型回测引擎
├── backtest_data_fetcher.py   # 数据获取器
└── short_term_backtest.py     # 原始回测引擎（保留）
```

### 集成点

回测功能已集成到 `ConversationHandler`:
- 意图识别: `RUN_BACKTEST`
- 处理方法: `_handle_run_backtest`
- 参数提取: `_extract_backtest_params`
- 报告格式化: `_format_backtest_report`

## 常见问题

**Q: 为什么回测收益是负数？**
A: 示例策略未经优化，仅用于演示。实际使用需要根据市场特征优化策略参数。

**Q: 可以测试加密货币吗？**
A: 当前版本仅支持韩股。加密货币回测功能计划中。

**Q: 如何添加自定义策略？**
A: 在 `BacktestDataFetcher` 中添加新的信号生成方法，参考现有的 `_generate_momentum_signals`。

**Q: 回测需要多长时间？**
A: 取决于数据量和信号数量，通常30天回测在1-5秒内完成。

**Q: 风控参数可以修改吗？**
A: 止损红线-10%、收益目标+20%、持仓时间10小时 是硬编码的，不建议修改（与实盘系统保持一致）。

## 更新日志

**2026-02-19**:
- ✅ 创建增强型回测引擎
- ✅ 集成强制风控规则（-10%止损、+20%目标、10小时窗口）
- ✅ 添加韩股数据获取器
- ✅ 集成到Telegram对话系统
- ✅ 支持3种内置策略（动量、均值回归、突破）
- ✅ 完整的性能指标和风控统计

## 下一步

计划功能：
- [ ] 支持加密货币回测
- [ ] 支持美股/港股回测
- [ ] 自定义策略上传
- [ ] 回测结果可视化（图表）
- [ ] 参数优化工具
- [ ] 实盘对比分析

---

**提示**: 回测是策略验证的重要工具，但请记住"历史表现不代表未来收益"。始终结合风险管理和市场分析做出投资决策。
