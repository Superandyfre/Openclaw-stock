# 推荐算法改进说明

## 📊 新增功能

### 1. 财报数据分析（基本面）

新增了对股票的基本面分析，包括以下财务指标：

#### 关键指标
- **PE比率** (市盈率): 评估估值水平（15-25最佳）
- **PB比率** (市净率): 账面价值评估（1-3最佳）
- **ROE** (净资产收益率): 盈利能力（>15%优秀，权重最高）
- **利润率**: 经营效率（>10%优秀）
- **营收增长率**: 成长性（>20%优秀）
- **资产负债率**: 财务健康（<70%健康）
- **流动比率**: 短期偿债能力（>1.5安全）

#### 盈利质量分析
- **超预期情况**: 是否超过分析师预期
- **惊喜度百分比**: 实际vs预期的差距
- **盈利趋势**: improving/stable/declining
- **财报质量得分**: -20~+20分

#### 评分公式
```
财报综合得分 = 基本面得分(-15~+15) + 盈利质量得分(-20~+20)
基本面得分 = (各指标得分 - 50) × 0.3
```

### 2. 宏观数据分析

新增了宏观经济环境评估：

#### 宏观指标
- **GDP增长率**: 经济增长（>3%加分）
- **失业率**: 就业市场（<4%加分）
- **通胀率**: 物价稳定（2-3%温和通胀最佳）
- **基准利率**: 货币政策（低利率利好股市）
- **VIX恐慌指数**: 市场波动率（<15乐观，>30恐慌）
- **市场情绪**: risk_on/neutral/risk_off

#### 评分公式
```
宏观得分 = GDP分(-5~+5) + 失业率分(-3~+3) + 
          通胀分(-5~+2) + 利率分(-3~+3) + VIX分(-7~+5)
```

## 🎯 改进后的完整打分体系

### 打分维度（6大类）

| 维度 | 分值范围 | 权重 | 说明 |
|------|---------|------|------|
| **技术面** | -30 ~ +70 | 高 | 价格动量、指标信号、成交量 |
| **基本面** | -15 ~ +15 | 中 | PE/PB/ROE/利润率等财务指标 |
| **盈利质量** | -20 ~ +20 | 中 | 超预期、趋势、财报质量 |
| **宏观面** | -20 ~ +20 | 中 | 经济环境、市场情绪 |
| **新闻面** | -15 ~ +15 | 中 | 全球新闻情绪分析 |
| **流动性** | 0 ~ +20 | 低 | 成交量归一化 |

**总分范围**: -50 ~ +150分（理论）

### 具体得分明细

#### 技术面（约50-70分）
- 价格动量: -10 ~ +10
- RSI: -10 ~ +10
- MACD: -8 ~ +8
- ADX: 0 ~ +10
- MFI: -8 ~ +8
- OBV: -5 ~ +5
- 量比: 0 ~ +8
- EMA排列: -5 ~ +5

#### 基本面（约30分，仅美股）
- 财报综合: -15 ~ +15
- 盈利质量: -20 ~ +20

#### 宏观面（约20分）
- GDP: -5 ~ +5
- 失业率: -3 ~ +3
- 通胀: -5 ~ +2
- 利率: -3 ~ +3
- VIX: -7 ~ +5

#### 其他
- 流动性: 0 ~ +20
- 新闻: -15 ~ +15

## 💡 使用方式

### 1. 启用功能

财报数据功能需要配置Finnhub API Key（已在项目中配置）：

```bash
# .env 文件中
FINNHUB_API_KEY=你的API密钥
```

### 2. 查看效果

重启Bot后，向Telegram发送以下命令：

```
分析行情
推荐几只股票
推荐几个加密货币
```

系统会在量化打分排行中显示新的评分维度。

### 3. 打分报告示例

```
【量化打分排行（多维度综合评分，供LLM深度研判）】
排名 代码           现价        涨跌    综合分  评分明细
─────────────────────────────────────────────────────
1    AAPL          ₩180,500   +2.34%   78.5分  动量:+3.5 | 流动性:18.2 | 宏观:neutral(+7) | RSI:50(+5.0) | MACD:BULLISH(+8) | ADX:28(+5.6) | MFI:45(+3.0) | OBV:BULLISH(+5) | 量比:1.8x(+4.0) | EMA:BULLISH(+5) | 财报:PE28.5/ROE25.3%(+8.2) | 盈利:超预期8.5%(+15) | 新闻:利好3条/利空1条(+5)
      👉 动态目标(ATR基准): 稳健₩185,200(+2.6%) / 进取₩192,800(+6.8%) / 止损₩175,300(-2.9%)
```

## 📈 改进效果

### 优势

1. **更全面的风险评估**
   - 结合技术面、基本面、宏观面三维度
   - 避免单一维度的片面判断

2. **更准确的价值判断**
   - PE/PB/ROE等财务指标筛选优质公司
   - 盈利超预期度捕捉成长机会

3. **更及时的环境感知**
   - 宏观经济周期调整仓位
   - VIX恐慌指数控制风险

4. **更智能的推荐**
   - LLM基于多维度综合评分推荐
   - 必须引用评分依据，不能随意编造

### 适用场景

- ✅ **美股分析**: 完整的技术面+基本面+宏观面+新闻面
- ✅ **韩股分析**: 技术面+宏观面+新闻面（财报功能待扩展）
- ✅ **加密货币**: 技术面+宏观面（市场情绪）+新闻面

## 🔧 技术实现

### 核心文件

1. **fundamental_data_fetcher.py** (新增)
   - 财报数据获取
   - 宏观数据获取
   - 综合评分计算

2. **conversation_handler.py** (修改)
   - `_score_and_rank_candidates()` 方法
   - 整合财报和宏观数据到打分系统

### 数据源

- **Finnhub API**: 美股财报数据（PE/PB/ROE/EPS等）
- **模拟数据**: 宏观指标（GDP/失业率/通胀/VIX）
  - 可扩展接入FRED API或其他真实数据源

### 缓存机制

- 财报数据: 1小时TTL
- 宏观数据: 1小时TTL
- 减少API调用，提高响应速度

## 📝 后续建议

### 短期优化

1. **韩股财报支持**
   - 接入DART API获取韩国上市公司财报
   - 适配韩国会计准则

2. **宏观数据实时化**
   - 接入FRED API获取真实宏观数据
   - 实时VIX指数获取

3. **行业分析**
   - 同行业对比
   - 行业轮动分析

### 长期规划

1. **因子模型**
   - 多因子选股模型
   - 机器学习优化权重

2. **回测验证**
   - 历史数据回测
   - 评分有效性验证

3. **动态调整**
   - 根据市场状况动态调整各维度权重
   - 牛熊市切换策略

## 🎓 参考资料

- **估值指标**: PE、PB、PS、EV/EBITDA
- **盈利能力**: ROE、ROA、ROIC、利润率
- **成长性**: 营收增长、利润增长、EPS增长
- **财务健康**: 负债率、流动比率、速动比率
- **宏观分析**: GDP、CPI、利率、PMI、VIX

---

**版本**: v1.0  
**日期**: 2026-02-21  
**作者**: OpenClaw Team
